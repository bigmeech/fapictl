# FAPI Wizard Guide

The `fapictl wizard` command provides an interactive terminal UI for configuring FAPI compliance tests. It guides you through all necessary setup steps and automatically generates required cryptographic materials.

## Quick Start

```bash
# Run the interactive wizard
./fapictl wizard

# Preview what would be created (dry run)
./fapictl wizard --dry-run

# Custom output location
./fapictl wizard --output-dir ./my-setup --config-file custom-config.yaml
```

## Features

### üé® Modern Terminal Interface
- **Beautiful forms** with colors and styling
- **Real-time validation** with immediate error feedback
- **Progress tracking** showing current step (Step X of Y)
- **Interactive widgets** (select boxes, multi-select, text inputs)

### üîß Comprehensive Configuration
1. **Basic Setup** - Client ID, redirect URI, OAuth scopes
2. **Endpoints** - Authorization, token, PAR, JWKS URIs
3. **Profile Selection** - Choose FAPI compliance profiles to test
4. **Authentication** - Configure mTLS and/or Private Key JWT
5. **Material Generation** - Automatic crypto material creation
6. **Configuration Output** - Generate ready-to-use config file

### üîê Automatic Crypto Generation
- **mTLS Certificates**: Self-signed client certificates for mutual TLS
- **JWT Signing Keys**: RSA private keys for JWT client assertions
- **Secure Permissions**: Files saved with proper permissions (600 for keys)
- **Smart Detection**: Only generates materials that don't already exist

## Command Options

| Flag | Description | Default |
|------|-------------|---------|
| `--output-dir` | Directory for generated files | `.` (current directory) |
| `--config-file` | Name of config file to create | `fapictl-config.yaml` |
| `--dry-run` | Preview without creating files | `false` |
| `--verbose` | Show detailed output | `false` |
| `--skip-tests` | Skip test execution prompt | `false` |

## Wizard Flow

### Step 1: Welcome
Confirm you're ready to start the configuration process.

### Step 2: Basic Configuration
```
OAuth 2.0 Client ID: my-client-id
Redirect URI: http://localhost:8080/callback (default)
OAuth 2.0 Scopes: openid accounts payments (default)
```

### Step 3: OAuth 2.0 Endpoints
```
Authorization Endpoint: https://auth.example.com/authorize (required)
Token Endpoint: https://auth.example.com/token (required)
PAR Endpoint: https://auth.example.com/par (optional)
JWKS URI: https://auth.example.com/.well-known/jwks.json (optional)
Introspection Endpoint: https://auth.example.com/introspect (optional)
```

### Step 4: FAPI Profiles
Select which compliance profiles to test:
- ‚òë **FAPI Read-Write** (Recommended) - Core FAPI security profile
- ‚òë **Mutual TLS** (Recommended) - Client certificate authentication  
- ‚òë **PKCE** (Recommended) - Proof Key for Code Exchange
- ‚òê **PAR** - Pushed Authorization Requests
- ‚òê **JAR** - JWT Secured Authorization Requests
- ‚òê **JARM** - JWT Secured Authorization Response Mode
- ‚òê **Open Banking UK** - UK Open Banking profile
- ‚òê **Open Finance Brazil** - Brazil Open Finance profile

### Step 5: Authentication Configuration
Choose authentication method:
- **Mutual TLS only** - Client certificate authentication
- **Private Key JWT only** - JWT client assertion
- **Both (Recommended)** - Use both methods for comprehensive testing

For each method, choose to use existing materials or generate new ones.

### Step 6: Material Generation
Automatically generates required files:
- `client-cert.pem` - mTLS client certificate (if needed)
- `client-key.pem` - mTLS private key (if needed)
- `jwt-signing-key.pem` - JWT signing key (if needed)
- `fapictl-config.yaml` - Complete configuration file

### Step 7: Completion
Option to immediately run tests with the new configuration.

## Example Output Files

### Generated Configuration (`fapictl-config.yaml`)
```yaml
# FAPI Compliance Test Configuration
# Generated by fapictl wizard on 2024-01-20T15:32:03Z

clientid: my-client-id
redirecturi: http://localhost:8080/callback
authorizationendpoint: https://auth.example.com/authorize
tokenendpoint: https://auth.example.com/token
parendpoint: https://auth.example.com/par
jwksuri: https://auth.example.com/.well-known/jwks.json
scopes:
  - openid
  - accounts  
  - payments
profiles:
  - fapi-rw
  - mtls
  - pkce
mtls:
  cert: ./client-cert.pem
  key: ./client-key.pem
privatekeyjwt:
  key: ./jwt-signing-key.pem
  kid: fapictl-key-1642689123
```

## Dry Run Mode

Use `--dry-run` to preview what would be created:

```bash
./fapictl wizard --dry-run --verbose
```

**Dry Run Features:**
- Shows exactly which files would be generated
- Displays file paths and permissions
- Previews configuration content (with --verbose)
- No actual files are created
- Perfect for planning and validation

## Navigation

### Keyboard Controls
- **Arrow keys** - Navigate between options
- **Tab/Shift+Tab** - Move between form fields
- **Space** - Toggle checkboxes
- **Enter** - Confirm selections and progress
- **Ctrl+C** - Exit wizard at any time

### Form Validation
- **Real-time validation** - See errors immediately as you type
- **Required field checking** - Cannot proceed with missing required data
- **URL format validation** - Ensures endpoints are valid URLs
- **Profile validation** - At least one profile must be selected

## Integration with Tests

After wizard completion, you can immediately run tests:

```bash
# Configuration is automatically passed to test command
./fapictl test --config fapictl-config.yaml --verbose
```

The wizard-generated configuration is fully compatible with all fapictl test commands and includes all necessary cryptographic materials.

## Troubleshooting

### Common Issues

**Permission Errors**
- Wizard creates files with secure permissions (600 for private keys)
- Ensure you have write access to the output directory

**Terminal Compatibility**  
- Requires terminal with color support for best experience
- Works in most modern terminals (iTerm2, Windows Terminal, etc.)
- Falls back gracefully in basic terminals

**Form Navigation**
- Use arrow keys and Tab to navigate
- Some terminals may require specific key combinations
- Ctrl+C always exits cleanly

### Getting Help

```bash
# Show wizard help
./fapictl wizard --help

# Test the wizard without creating files
./fapictl wizard --dry-run

# Use verbose mode for detailed output
./fapictl wizard --verbose
```

The wizard provides the fastest and most user-friendly way to get started with FAPI compliance testing!